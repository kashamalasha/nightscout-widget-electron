name: Publish to WinGet

on:
  workflow_dispatch:

jobs:
  publish-winget:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install wingetcreate
        run: |
          winget install `
          --id Microsoft.WingetCreate `
          --source winget `
          --accept-package-agreements `
          --accept-source-agreements `
          --quiet *> $null

      - name: Read version from WinGet version manifest
        id: manifest_version
        shell: pwsh
        run: |
          $path = "build/winget/kashamalasha.Owlet.yaml"
          $content = Get-Content $path
          $line = $content | Where-Object { $_ -match '^PackageVersion:\s*(.+)$' }
          if (-not $line) { throw "PackageVersion not found in manifest" }
          $version = $line -replace '^PackageVersion:\s*', ''
          $version = $version.Trim()
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Read the install path from the installer manifest
        id: install_path
        shell: pwsh
        run: |
          $path = "build/winget/kashamalasha.Owlet.installer.yaml"
          $content = Get-Content $path
          $line = $content | Where-Object { $_ -match '^\s*InstallerUrl:\s*(.+)$' }
          if (-not $line) { throw "InstallerUrl not found in manifest" }
          $url = $line -replace '^\s*InstallerUrl:\s*', ''
          $url = $url.Trim()
          "installUrl=$url" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Compute SHA256 for the latest release
        id: hash
        shell: pwsh
        run: |
          $version = "${{ steps.manifest_version.outputs.version }}"
          $url = "${{ steps.install_path.outputs.installUrl }}"
          Write-Host "Downloading: $url"
          Invoke-WebRequest -Uri $url -OutFile installer.exe
          $hash = (Get-FileHash -Path installer.exe -Algorithm SHA256).Hash
          "sha256=$hash" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Patch WinGet installer manifest
        shell: pwsh
        run: |
          $path = "build/winget/kashamalasha.Owlet.installer.yaml"
          $hash = "${{ steps.hash.outputs.sha256 }}"

          $content = Get-Content $path
          $content = $content -replace '(?m)^(\s*InstallerSha256:\s*).+$', "`$1$hash"
          Set-Content -Path $path -Value $content

      - name: Validate manifest
        shell: pwsh
        run: |
          winget validate `
            --manifest "build/winget"

      - name: Submit manifest
        shell: pwsh
        env:
          WINGET_TOKEN: ${{ secrets.WINGET_TOKEN }}
        run: |
          wingetcreate submit build/winget
