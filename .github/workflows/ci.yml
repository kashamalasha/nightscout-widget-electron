name: CI (build & test on Linux, macOS, Windows)

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Adjust Node version to match project requirements
env:
  NODE_VERSION: '21.1.0'           # Matches check.yml and project requirements
  CI: true
  ELECTRON_SKIP_BINARY_DOWNLOAD: 0  # Allow electron to fetch prebuilt binaries
  # Disable code signing in CI (we're not distributing signed builds here)
  CSC_IDENTITY_AUTO_DISCOVERY: 'false'
  # Optional performance tweak for electron-builder
  ELECTRON_BUILDER_COMPRESSION: 'maximum'

jobs:
  build-test:
    name: ${{ matrix.os }} / Node 21.1.0
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # ---- OS-specific prerequisites (only what we need for building) ----
      - name: Linux build prerequisites
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          # rpm: for rpm target if ever enabled; libarchive-tools provides bsdtar used by electron-builder
          # wmctrl and xdg-utils: dependencies needed for the app to work properly
          sudo apt-get install -y libarchive-tools rpm wmctrl xdg-utils

      - name: Windows build prerequisites
        if: startsWith(matrix.os, 'windows')
        run: |
          echo Windows prerequisites handled by GitHub Actions runner

      - name: macOS build prerequisites
        if: startsWith(matrix.os, 'macos')
        run: |
          # macOS runner already has necessary tools
          echo macOS prerequisites available

      # ---- Install deps ----
      - name: Install dependencies
        run: npm ci

      # ---- Lint (runs eslint) ----
      - name: Lint
        run: npm run lint

      # ---- Unit tests (Jest config exists in repo) ----
      - name: Test
        run: npm test

      # ---- Version check ----
      - name: Version Check
        run: npm run version-check

      # ---- Build platform-specific artifacts with electron-builder ----
      # Building without publishing, matching your package.json build config
      - name: Build (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          npx electron-builder --linux AppImage --publish never

      - name: Build (Windows)
        if: startsWith(matrix.os, 'windows')
        run: |
          npx electron-builder --win nsis zip --publish never

      - name: Build (macOS)
        if: startsWith(matrix.os, 'macos')
        # Note: Notarization is disabled in package.json (notarize: false)
        # If you later add Apple notarization/secrets, uncomment the env block:
        # env:
        #   APPLE_ID: ${{ secrets.APPLE_ID }}
        #   APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        #   APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        #   CSC_LINK: ${{ secrets.MAC_CERT_P12_BASE64 }}
        #   CSC_KEY_PASSWORD: ${{ secrets.MAC_CERT_PWD }}
        run: |
          # Build for both Apple Silicon and Intel (universal) per package.json config
          # Since notarize is false, this builds unsigned DMG
          npx electron-builder --mac dmg zip --publish never

      # ---- Upload artifacts from dist/ for download and testing ----
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ runner.os }}-artifacts
          path: |
            dist/*.AppImage
            dist/*.deb
            dist/*.dmg
            dist/*.zip
            dist/*.exe
            dist/*.msi
            dist/*.yml
            dist/*.blockmap
          if-no-files-found: warn
          retention-days: 7  # Keep artifacts for 7 days
